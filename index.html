<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>카바메이트계 농약 검출 키트</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>카바메이트계 농약 검출 키트</h1>
  <hr>

  <div class="container">

    <!-- 왼쪽 블록 -->
    <div class="left-block">
      <h2>시료 전처리 방법</h2>
      <div class="preprocess-container">

        <!-- 1열: 채소류 -->
        <div class="table-col">
          <table class="fixed-table">
            <colgroup><col><col></colgroup>
            <caption>채소류</caption>
            <tr><td>무의 뿌리, 생강, 당근</td><td>물로 가볍게 씻어 흙 제거</td></tr>
            <tr><td>무의 잎, 케일</td><td>변질 잎 제거</td></tr>
            <tr><td>배추, 양배추, 상추, 양상추</td><td>바깥 변질 잎 및 심 제거</td></tr>
            <tr><td>양파, 파, 마늘, 부추</td><td>껍질질 및 잔뿌리 제거</td></tr>
            <tr><td>시금치</td><td>잔뿌리 및 변질 잎 제거</td></tr>
            <tr><td>고사리, 샐러리, 아스파라거스, 쑥갓</td><td>뿌리 및 변질 잎 제거</td></tr>
            <tr><td>고추, 토마토, 피망, 가지</td><td>받침 제거</td></tr>
            <tr><td>수박, 참외, 멜론, 오이, 호박</td><td>꼭지 제거</td></tr>
          </table>
        </div>

        <!-- 2열: 과일류 -->
        <div class="table-col">
          <table class="fixed-table">
            <colgroup><col><col></colgroup>
            <caption>과일류</caption>
            <tr><td>딸기</td><td>받침 제거</td></tr>
            <tr><td>포도</td><td>꼭지 및 줄기 제거</td></tr>
            <tr><td>감</td><td>받침 및 씨 제거</td></tr>
            <tr><td>복숭아, 살구, 자두, 매실, 체리</td><td>꼭지 및 씨 제거</td></tr>
            <tr><td>사과, 배, 모과, 바나나, 키위</td><td>꼭지(부분) 제거</td></tr>
            <tr><td>밀감, 레몬, 자몽, 오렌지, 감귤류</td><td>과실 전체</td></tr>
          </table>
        </div>

        <!-- 3열: 곡류 + 서류 + 두류 -->
        <div class="table-col">
          <table class="fixed-table">
            <colgroup><col><col></colgroup>
            <caption>곡류</caption>
            <tr><td>옥수수</td><td>포엽, 수염 및 이삭 속 제거</td></tr>
            <tr><td>쌀, 보리, 밀, 메밀, 호밀, 수수, 귀리, 조, 율무</td><td>탈각</td></tr>
            <tr><td>기타 곡류</td><td>탈각</td></tr>
          </table>
          <table class="fixed-table small">
            <colgroup><col><col></colgroup>
            <caption>서류</caption>
            <tr><td>감자, 고구마, 토란 및 기타 서류</td><td>잔뿌리 제거 후 물로 가볍게 씻어 흙 제거</td></tr>
          </table>
          <table class="fixed-table small">
            <colgroup><col><col></colgroup>
            <caption>두류</caption>
            <tr><td>대두, 팥, 녹두, 완두, 강낭콩, 땅콩 및 기타 두류</td><td>깍지 제거</td></tr>
          </table>
        </div>

      </div> <!-- .preprocess-container -->

      <div class="production-method">
        <h2>사용 방법</h2>
        <div class="video-row">
          <figure class="video-figure">
            <iframe
              src="https://www.youtube.com/embed/kftWI4lAqTY?si=rm3wKAhLSUQijm8u"
              title="YouTube video player"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
            <figcaption>step1. 암실 조립</figcaption>
          </figure>

          <figure class="video-figure">
            <iframe
              src="https://www.youtube.com/embed/z2fw3-9BVeA?si=CxkXUnLYQbzx5OI1"
              title="YouTube video player"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
            <figcaption>step2. 색상 촬영</figcaption>
          </figure>
        </div>
      </div>
    </div> <!-- .left-block -->

    <!-- 오른쪽 블록 -->
    <div class="right-block" id="rightPanel">
      <h2 style="text-align: center;">이미지를 업로드하세요</h2>

      <div class="upload-drag" id="dropzone">
        <div style="text-align:center">
          <label for="imgFile" style="cursor:pointer; display:inline-block;">
            <img src="upload_icon.png" alt="이미지 업로드" style="width:150px; height:auto;">
            <p>클릭하여 이미지 업로드</p>
          </label>
          <input id="imgFile" type="file" accept="image/*" style="display:none;">

          <!-- 평균 색상 스와치만 표시 -->
          <div id="swatch" title="평균 색상 미리보기">미리보기</div>
        </div>
      </div>

      <!-- RGB는 화면에서 숨김(자동 채움) -->
      <input id="r" type="hidden">
      <input id="g" type="hidden">
      <input id="b" type="hidden">

      <button id="run" disabled>확인</button>
      <h3 style="text-align: center;">AI 분석 결과</h3>
      <p class="result">예상 농약 농도: <span id="out">--</span></p>
    </div>
  </div>

  <script>
    /* ----------------- 모델 ----------------- */
    const coef = [
      0.000005712, -0.000003164, 0.000001429,
      0.000696053, -0.000010865, 0.000630236,
      -0.000482059, -0.000244397, 0.000260700,
      -0.000022404, 0.000025543, 0.000028715,
      -0.000019486, -0.000014450, -0.000019760,
      -0.000062310, 0.000150870, -0.000096179,
      0.000025402
    ];
    const intercept = -9.137034416;

    function polyFeatures([R, G, B]) {
      return [
        R, G, B,
        R*R, R*G, R*B,
        G*G, G*B, B*B,
        R*R*R, R*R*G, R*R*B,
        R*G*G, R*G*B, R*B*B,
        G*G*G, G*G*B, G*B*B,
        B*B*B
      ];
    }
    function predict(rgb) {
      const x = polyFeatures(rgb);
      const yLog = x.reduce((s, xi, i) => s + xi * coef[i], intercept);
      return Math.pow(10, yLog); // 로그 역변환
    }

    /* ----------------- 상태 보조 함수 ----------------- */
    const runBtn = document.getElementById('run');
    const rightPanel = document.getElementById('rightPanel');
    const outEl = document.getElementById('out');

    function rgbReady() {
      const R = +document.getElementById('r').value;
      const G = +document.getElementById('g').value;
      const B = +document.getElementById('b').value;
      return ![R, G, B].some(isNaN);
    }
    function updateRunState() {
      // 결과는 업로드 후 버튼 누르기 전까지 숨김
      rightPanel.classList.remove('has-result');
      outEl.textContent = '--';
      runBtn.disabled = !rgbReady();
    }

    /* ----------------- 예측 버튼 ----------------- */
    runBtn.addEventListener('click', () => {
      if (!rgbReady()) return;

      // 버튼 동적 반응(로딩)
      runBtn.classList.add('loading');
      runBtn.disabled = true;

      // 즉시 계산 후 표시
      const R = +document.getElementById('r').value;
      const G = +document.getElementById('g').value;
      const B = +document.getElementById('b').value;
      const conc = predict([R, G, B]);
      let msg = '';
      const concValue = conc * 0.004;
      if (conc > 2000 * 0.004) {
        msg = '다시 용액을 촬영해주세요';
      } else if (conc < 7.5 * 0.004) {
        msg = '농약이 검출되지 않음';
      } else {
        msg = '농약이 검출됨';
      }
      outEl.textContent = `${(conc*0.004).toFixed(2)} mg/kg[ppm]\n${msg}`;
      rightPanel.classList.add('has-result');

      // 로딩 종료
      runBtn.classList.remove('loading');
      runBtn.disabled = false;
    });

    /* ----------------- 이미지 → 중앙 ROI 평균색 ----------------- */
    const CROP_RATIO = 0.5;
    const MAX_SIZE = 256;

    function getAverageRGBFromFile(file, maxSize = MAX_SIZE, cropRatio = CROP_RATIO) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          const scale = Math.min(maxSize / img.width, maxSize / img.height, 1);
          const w = Math.max(1, Math.round(img.width  * scale));
          const h = Math.max(1, Math.round(img.height * scale));

          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d', { willReadFrequently: true });
          ctx.drawImage(img, 0, 0, w, h);

          const s = Math.max(1, Math.floor(Math.min(w, h) * cropRatio));
          const x0 = Math.floor((w - s) / 2);
          const y0 = Math.floor((h - s) / 2);

          const { data } = ctx.getImageData(x0, y0, s, s);
          let r=0,g=0,b=0,n=0;
          for (let i=0; i<data.length; i+=4){
            const a = data[i+3]; if (a===0) continue;
            r += data[i]; g += data[i+1]; b += data[i+2]; n++;
          }
          if (!n) return reject(new Error('ROI에 유효 픽셀이 없습니다.'));
          resolve([Math.round(r/n), Math.round(g/n), Math.round(b/n)]);
        };
        img.onerror = reject;

        const fr = new FileReader();
        fr.onload = e => { img.src = e.target.result; };
        fr.readAsDataURL(file);
      });
    }

    async function processImageFile(file) {
      try {
        const [R, G, B] = await getAverageRGBFromFile(file);
        // 숨겨진 입력값 채우기
        document.getElementById('r').value = R;
        document.getElementById('g').value = G;
        document.getElementById('b').value = B;

        // 스와치 갱신
        const sw = document.getElementById('swatch');
        if (sw) {
          sw.style.background = `rgb(${R}, ${G}, ${B})`;
          sw.textContent = `RGB(${R}, ${G}, ${B})`;
        }

        // 업로드 후에는 버튼만 활성화(자동 예측 금지)
        updateRunState();
      } catch (err) {
        alert('이미지를 처리할 수 없습니다. 다른 파일로 시도해 주세요.');
        console.error(err);
      }
    }

    // 파일 선택/드롭
    (function initUpload(){
      const dropzone = document.getElementById('dropzone');
      const input = document.getElementById('imgFile');

      input.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (file) processImageFile(file);
      });

      dropzone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropzone.classList.add('drag'); });
      dropzone.addEventListener('dragleave', ()=> dropzone.classList.remove('drag'));
      dropzone.addEventListener('drop', (e)=>{
        e.preventDefault(); dropzone.classList.remove('drag');
        const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if (file) processImageFile(file);
      });

      // 초기 상태: 버튼 비활성/결과 숨김
      updateRunState();
    })();
  </script>
</body>
</html>
